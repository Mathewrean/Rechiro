{% extends 'base.html' %}

{% block title %}Fisherman Dashboard - Fish Market{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="container mx-auto px-4">
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-anchor mr-3 text-blue-600"></i>Fisherman Dashboard
                </h1>
                <p class="text-gray-500 mt-1">Welcome back, {{ user.username }}!</p>
            </div>
            <a href="{% url 'fishing:add_fish' %}" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                <i class="fas fa-plus mr-2"></i>List New Fish
            </a>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-3">
                <i class="fas fa-user-check mr-2 text-blue-600"></i>Chairman Approval
            </h2>
            {% if profile.chairman_approved %}
                <p class="text-green-700 font-medium">
                    Approved{% if profile.chairman_name %} by {{ profile.chairman_name }}{% endif %}. You can list fish.
                </p>
            {% else %}
                <p class="text-amber-700 mb-3">Approval is required before listing fish.</p>
                {% if approval_request %}
                    <p class="text-sm text-gray-700 mb-3">
                        Latest request status: <span class="font-semibold">{{ approval_request.get_status_display }}</span>
                    </p>
                {% endif %}
                <form method="post" action="{% url 'fishing:request_chairman_approval' %}">
                    {% csrf_token %}
                    <label for="approval-notes" class="block text-sm text-gray-700 mb-2">Optional note for the chairman</label>
                    <textarea id="approval-notes" name="notes" rows="2" class="w-full border border-gray-300 rounded-lg px-3 py-2 mb-3" placeholder="Landing site details or contact note"></textarea>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium">
                        Submit Approval Request
                    </button>
                </form>
            {% endif %}
        </div>

        {% if notifications %}
        <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-bell mr-2 text-emerald-600"></i>Payment Alerts
                </h2>
                <span class="px-3 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-700">
                    {{ unread_notifications_count }} unread
                </span>
            </div>
            <div class="space-y-3">
                {% for note in notifications|slice:":5" %}
                <div class="border rounded-lg p-4 {% if not note.is_read %}border-emerald-300 bg-emerald-50{% else %}border-gray-200 bg-gray-50{% endif %}">
                    <p class="font-semibold text-gray-800">Payment Confirmed - Order #{{ note.order.order_number }}</p>
                    <p class="text-sm text-gray-700">
                        Buyer: {{ note.buyer.username|default:"Customer" }} | Fish: {{ note.fish_item }} | Weight: {{ note.weight_kg }}kg
                    </p>
                    <p class="text-sm text-gray-700">
                        Total: KES {{ note.total_amount|floatformat:2 }} | Net Earnings: KES {{ note.net_earnings|floatformat:2 }}
                    </p>
                    <p class="text-sm text-gray-700">
                        Receipt: {{ note.receipt_number }} | {{ note.created_at|date:"Y-m-d H:i" }}
                    </p>
                    {% if not note.is_read %}
                    <button class="mt-2 text-sm text-blue-600 hover:underline mark-read-btn" data-id="{{ note.id }}">
                        Mark as read
                    </button>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Total Listings</p>
                        <p class="text-3xl font-bold text-gray-800">{{ fish_listings.count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-fish text-blue-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-green-600">{{ available_fish.count }} available</span>
                    <span class="mx-2 text-gray-300">|</span>
                    <span class="text-gray-500">{{ sold_fish.count }} sold</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Gross Revenue</p>
                        <p class="text-3xl font-bold text-green-600">KES {{ gross_revenue|floatformat:2 }}</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-green-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 text-sm space-y-1">
                    <p class="text-gray-500">Platform Fee (2%): KES {{ platform_fee_total|floatformat:2 }}</p>
                    <p class="text-gray-700 font-semibold">Net Earnings: KES {{ net_earnings|floatformat:2 }}</p>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Fish Sold</p>
                        <p class="text-3xl font-bold text-gray-800">{{ total_items_sold|floatformat:1 }} kg</p>
                    </div>
                    <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-weight-hanging text-purple-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center text-sm">
                    <span class="text-gray-500">Total weight sold</span>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Pending Orders</p>
                        <p class="text-3xl font-bold text-yellow-600">{{ pending_orders }}</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600 text-xl"></i>
                    </div>
                </div>
                <div class="mt-4">
                    <a href="{% url 'fishing:order_fulfillment' %}" class="text-blue-600 hover:underline text-sm">
                        View pending orders →
                    </a>
                </div>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Recent Orders -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                        <h2 class="text-xl font-bold text-gray-800">Recent Orders</h2>
                        <a href="{% url 'fishing:order_fulfillment' %}" class="text-blue-600 hover:underline text-sm">View All</a>
                    </div>
                    {% if recent_orders %}
                    <div class="divide-y divide-gray-200">
                        {% for item in recent_orders|slice:":5" %}
                        <div class="p-4 flex items-center justify-between hover:bg-gray-50">
                            <div>
                                <p class="font-semibold text-gray-800">Order #{{ item.order.order_number }}</p>
                                <p class="text-sm text-gray-500">{{ item.weight_kg }}kg {{ item.fish_name }}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-bold text-green-600">KES {{ item.total_price|floatformat:0 }}</p>
                                <span class="px-2 py-1 rounded-full text-xs font-medium
                                    {% if item.order.status == 'PENDING' %}bg-yellow-100 text-yellow-800
                                    {% elif item.order.status == 'PAID' %}bg-blue-100 text-blue-800
                                    {% elif item.order.status == 'READY' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ item.order.get_status_display_name }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-shopping-bag text-4xl text-gray-300 mb-3"></i>
                        <p>No orders yet. List some fish to get started!</p>
                    </div>
                    {% endif %}
                </div>

                <!-- My Fish Listings -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                        <h2 class="text-xl font-bold text-gray-800">My Fish Listings</h2>
                        <a href="{% url 'fishing:my_fish_listing' %}" class="text-blue-600 hover:underline text-sm">View All</a>
                    </div>
                    {% if fish_listings %}
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 p-4">
                        {% for fish in fish_listings|slice:":6" %}
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-2">
                                <h3 class="font-semibold text-gray-800 truncate">{{ fish.name }}</h3>
                                <span class="px-2 py-0.5 rounded-full text-xs
                                    {% if fish.status == 'available' %}bg-green-100 text-green-800
                                    {% elif fish.status == 'sold' %}bg-gray-100 text-gray-800
                                    {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                    {{ fish.get_status_display }}
                                </span>
                            </div>
                            <p class="text-sm text-gray-500 mb-2">{{ fish.get_fish_type_display }}</p>
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-lg font-bold text-green-600">KES {{ fish.price_per_kg }}</p>
                                    <p class="text-xs text-gray-500">{{ fish.available_weight }}kg left</p>
                                </div>
                                <a href="{% url 'fishing:edit_fish' fish.id %}" class="text-blue-600 hover:text-blue-700">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-fish text-4xl text-gray-300 mb-3"></i>
                        <p>No fish listings yet.</p>
                        <a href="{% url 'fishing:add_fish' %}" class="text-blue-600 hover:underline">Add your first listing</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Profile Card -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Your Profile</h2>
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                            <i class="fas fa-user text-blue-600 text-xl"></i>
                        </div>
                        <p class="font-semibold text-gray-800">{{ user.username }}</p>
                        {% if profile.is_verified %}
                        <span class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium mt-1">
                            <i class="fas fa-check-circle mr-1"></i>Verified
                        </span>
                        {% endif %}
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-500">Location</span>
                            <span class="text-gray-800">{{ profile.location }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Phone</span>
                            <span class="text-gray-800">{{ profile.phone }}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500">Fulfillment</span>
                            <span class="text-gray-800">{{ profile.get_fulfillment_method_display }}</span>
                        </div>
                    </div>
                    <a href="{% url 'users:edit_profile' %}" class="block w-full bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-lg font-medium text-center mt-4 transition-colors">
                        Edit Profile
                    </a>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h2 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h2>
                    <div class="space-y-3">
                        <a href="{% url 'fishing:add_fish' %}" class="flex items-center p-3 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors">
                            <i class="fas fa-plus-circle text-blue-600 mr-3"></i>
                            <span class="text-gray-800">List New Fish</span>
                        </a>
                        <a href="{% url 'fishing:order_fulfillment' %}" class="flex items-center p-3 bg-green-50 rounded-lg hover:bg-green-100 transition-colors">
                            <i class="fas fa-tasks text-green-600 mr-3"></i>
                            <span class="text-gray-800">Fulfill Orders</span>
                        </a>
                        <a href="{% url 'fishing:marketplace' %}" class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                            <i class="fas fa-eye text-gray-600 mr-3"></i>
                            <span class="text-gray-800">View Marketplace</span>
                        </a>
                    </div>
                </div>

                <!-- Tips -->
                <div class="bg-yellow-50 rounded-xl p-6">
                    <h3 class="font-semibold text-yellow-800 mb-2">
                        <i class="fas fa-lightbulb mr-2"></i>Tips
                    </h3>
                    <ul class="text-sm text-yellow-700 space-y-2">
                        <li>• Add clear photos of your fish</li>
                        <li>• Update stock regularly</li>
                        <li>• Respond quickly to orders</li>
                        <li>• Keep delivery notes accurate</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  };
  const buttons = document.querySelectorAll('.mark-read-btn');
  let unreadCount = {{ unread_notifications_count|default:0 }};
  buttons.forEach((btn) => {
    btn.addEventListener('click', function () {
      const id = this.dataset.id;
      fetch(`/fishing/fisherman/notifications/${id}/read/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken')},
      }).then(() => window.location.reload());
    });
  });

  // Lightweight real-time alert: poll every 10s for newly confirmed payments.
  setInterval(() => {
    fetch('{% url "fishing:api_seller_notifications" %}')
      .then(resp => resp.json())
      .then(data => {
        if (data.success && Number(data.unread_count) > Number(unreadCount)) {
          window.location.reload();
        }
      })
      .catch(() => {});
  }, 10000);
});
</script>
{% endblock %}
